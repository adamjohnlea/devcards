<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Generate collectible trading cards for any GitHub developer. Enter a username to reveal their rarity tier, special ability, top languages, and career stats.">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' https://avatars.githubusercontent.com https://*.githubusercontent.com; connect-src https://api.github.com; object-src 'none'; base-uri 'self'; form-action 'self';">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<title>Dev Trading Cards</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --border: #2a2a3a;
    --accent: #00f5ff;
    --text: #e0e0f0;
    --muted: #5a5a7a;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    background-image:
      radial-gradient(circle at 20% 50%, rgba(0,245,255,0.04) 0%, transparent 60%),
      radial-gradient(circle at 80% 20%, rgba(180,0,255,0.04) 0%, transparent 60%);
  }

  .app-header {
    text-align: center;
    margin-bottom: 48px;
  }

  .app-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(42px, 8vw, 72px);
    letter-spacing: 0.06em;
    background: linear-gradient(135deg, #00f5ff 0%, #b400ff 50%, #ff006a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-decoration: none;
    background-clip: text;
    line-height: 1;
  }

  .app-subtitle {
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    letter-spacing: 0.3em;
    color: var(--muted);
    text-transform: uppercase;
    margin-top: 8px;
  }

  .search-wrap {
    display: flex;
    gap: 12px;
    margin-bottom: 56px;
    width: 100%;
    max-width: 440px;
  }

  .search-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    padding: 14px 18px;
    outline: none;
    transition: border-color 0.2s;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .search-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 20px rgba(0,245,255,0.1);
  }

  .search-input::placeholder { color: var(--muted); }

  .search-btn {
    background: linear-gradient(135deg, #00f5ff, #b400ff);
    border: none;
    color: #000;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 0.1em;
    padding: 14px 28px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .search-btn:hover { opacity: 0.85; }
  .search-btn:active { transform: scale(0.97); }
  .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .status-msg {
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 32px;
    min-height: 22px;
  }
  .status-msg.error { color: #ff4466; }

  /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card-scene {
    perspective: 1200px;
  }

  .card {
    width: 340px;
    min-height: 520px;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    cursor: pointer;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08), 0 32px 80px rgba(0,0,0,0.7);
    animation: cardReveal 0.7s cubic-bezier(0.23, 1, 0.32, 1) both;
  }

  @keyframes cardReveal {
    from { opacity: 0; transform: translateY(40px) rotateX(8deg); }
    to   { opacity: 1; transform: translateY(0) rotateX(0); }
  }

  .card:hover {
    transform: rotateY(6deg) rotateX(-3deg) scale(1.02);
  }

  .card-bg {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .card-foil {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    opacity: 0;
    background: linear-gradient(
      105deg,
      transparent 40%,
      rgba(255,255,255,0.06) 50%,
      transparent 60%
    );
    transition: opacity 0.3s;
  }

  .card:hover .card-foil { opacity: 1; }

  .card-inner {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 0;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px 10px;
  }

  .card-series {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 11px;
    letter-spacing: 0.3em;
    color: rgba(255,255,255,0.5);
  }

  .rarity-block {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .rarity-badge {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 11px;
    letter-spacing: 0.2em;
    padding: 3px 10px;
    border-radius: 2px;
    border: 1px solid currentColor;
  }

  .rarity-modifier {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 9px;
    letter-spacing: 0.2em;
    color: rgba(255,255,255,0.35);
  }

  .card-portrait-wrap {
    position: relative;
    margin: 0 18px 0;
  }

  .card-portrait-frame {
    position: relative;
    overflow: hidden;
    border-radius: 4px;
  }

  .card-portrait-frame::before {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 1;
    background: linear-gradient(to bottom, transparent 60%, var(--card-bg-end, #0d1117) 100%);
  }

  .card-avatar {
    width: 100%;
    height: 210px;
    object-fit: cover;
    display: block;
    filter: contrast(1.05) saturate(1.1);
  }

  .card-name-block {
    padding: 10px 18px 4px;
  }

  .card-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 30px;
    letter-spacing: 0.05em;
    color: #fff;
    line-height: 1;
  }

  .card-handle {
    font-size: 11px;
    color: rgba(255,255,255,0.45);
    letter-spacing: 0.15em;
    margin-top: 2px;
  }

  .card-ability {
    margin: 6px 18px 10px;
    background: rgba(255,255,255,0.05);
    border-left: 2px solid;
    padding: 8px 12px;
    border-radius: 0 3px 3px 0;
  }

  .card-ability-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 10px;
    letter-spacing: 0.25em;
    opacity: 0.55;
    margin-bottom: 3px;
  }

  .card-ability-text {
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.85);
    letter-spacing: 0.05em;
  }

  .card-stats {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1px;
    background: rgba(255,255,255,0.08);
    margin: 0 18px;
    border-radius: 4px;
    overflow: hidden;
  }

  .stat-cell {
    background: rgba(0,0,0,0.35);
    padding: 10px 8px;
    text-align: center;
  }

  .stat-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 0.02em;
    color: #fff;
    line-height: 1;
  }

  .stat-label {
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
    letter-spacing: 0.15em;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    margin-top: 3px;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 12px 18px 14px;
    margin-top: auto;
  }

  .card-lang-badges {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .lang-badge {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    padding: 3px 8px;
    border-radius: 2px;
    letter-spacing: 0.1em;
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.65);
  }

  .card-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .card-vintage {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.1em;
  }

  .card-number {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 0.1em;
    text-align: right;
  }

  /* â”€â”€ CARD ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card-actions {
    display: flex;
    gap: 8px;
    margin-top: 28px;
    width: 340px;
  }

  .action-btn {
    flex: 1;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.12em;
    padding: 10px 6px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .action-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,245,255,0.05);
  }

  .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .share-btn:hover {
    border-color: #e7e7e7;
    color: #e7e7e7;
    background: rgba(231,231,231,0.05);
  }

  .gitdex-btn:hover {
    border-color: #00cc88;
    color: #00cc88;
    background: rgba(0,204,136,0.05);
  }

  .gitdex-btn.in-dex {
    border-color: #00cc88;
    color: #00cc88;
    background: rgba(0,204,136,0.08);
  }

  /* â”€â”€ GITDEX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gitdex-section {
    width: 100%;
    max-width: 560px;
    margin-top: 64px;
    border-top: 1px solid var(--border);
    padding-top: 28px;
  }

  .gitdex-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 20px;
  }

  .gitdex-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 0.2em;
    background: linear-gradient(135deg, #00f5ff, #b400ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .gitdex-count {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .gitdex-grid {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .dex-tile {
    position: relative;
    width: 100px;
    cursor: pointer;
    transition: transform 0.15s;
  }

  .dex-tile:hover { transform: translateY(-4px); }

  .dex-tile__avatar {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    display: block;
    border: 2px solid;
  }

  .dex-tile__name {
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255,255,255,0.55);
    letter-spacing: 0.04em;
    text-align: center;
    margin-top: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .dex-tile__rarity {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-align: center;
    margin-top: 2px;
  }

  .dex-tile__remove {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 17px;
    height: 17px;
    border-radius: 50%;
    background: #ff4466;
    border: none;
    color: #fff;
    font-size: 11px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .dex-tile:hover .dex-tile__remove { opacity: 1; }

  .dex-tile--drag-over {
    outline: 2px solid var(--accent);
    outline-offset: 3px;
    border-radius: 8px;
  }

  .dex-tile--dragging {
    transform: scale(1.08) rotate(2deg);
    box-shadow: 0 16px 40px rgba(0,0,0,0.6), 0 0 0 2px rgba(0,245,255,0.45);
    z-index: 10;
  }

  .dex-tile[draggable] { cursor: grab; }
  .dex-tile[draggable]:active { cursor: grabbing; }

  /* Suppress native image long-press menu and text selection on touch */
  .dex-tile {
    -webkit-touch-callout: none;
    user-select: none;
  }
  .dex-tile__avatar { -webkit-user-drag: none; }

  .hidden { display: none; }

  .spinner {
    width: 32px; height: 32px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .examples {
    margin-top: 16px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  .examples span {
    color: rgba(0,245,255,0.6);
    cursor: pointer;
    margin: 0 6px;
    transition: color 0.2s;
  }
  .examples span:hover { color: var(--accent); }

  /* â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .settings-wrap {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0;
  }

  .settings-toggle {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 36px;
    height: 36px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    border-radius: 4px;
  }

  .settings-toggle:hover { border-color: var(--accent); color: var(--accent); }
  .settings-toggle.active { border-color: #00cc88; color: #00cc88; }

  .settings-panel {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    width: 280px;
  }

  .settings-panel.open { max-height: 240px; }

  .settings-panel-inner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    padding: 16px;
    margin-top: -1px;
    border-radius: 0 0 4px 4px;
  }

  .settings-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 0.2em;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .settings-hint {
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.05em;
    margin-bottom: 12px;
    line-height: 1.5;
  }

  .settings-hint a {
    color: rgba(0,245,255,0.7);
    text-decoration: none;
  }

  .settings-hint a:hover { color: var(--accent); }

  .settings-token-row {
    display: flex;
    gap: 8px;
  }

  .settings-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 8px 10px;
    outline: none;
    min-width: 0;
    transition: border-color 0.2s;
    border-radius: 2px;
  }

  .settings-input:focus { border-color: var(--accent); }

  .settings-save {
    background: linear-gradient(135deg, #00f5ff, #b400ff);
    border: none;
    color: #000;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 0.1em;
    padding: 8px 14px;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
    border-radius: 2px;
  }

  .settings-save:hover { opacity: 0.85; }

  .settings-status {
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    letter-spacing: 0.08em;
    margin-top: 8px;
    min-height: 16px;
  }

  .settings-status.ok  { color: #00cc88; }
  .settings-status.err { color: #ff4466; }
</style>
</head>
<body>

<div class="settings-wrap">
  <button class="settings-toggle" id="settingsToggle" onclick="toggleSettings()" title="GitHub Token Settings">âš™</button>
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-panel-inner">
      <div class="settings-label">GitHub Token</div>
      <div class="settings-hint">
        Raises the API limit from 60 to 5,000 req/hr.<br>
        <a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">Generate a token â†’</a>
      </div>
      <div class="settings-token-row">
        <input class="settings-input" id="tokenInput" type="password" placeholder="ghp_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off" />
        <button class="settings-save" onclick="saveToken()">SAVE</button>
      </div>
      <div class="settings-status" id="settingsStatus"></div>
    </div>
  </div>
</div>

<div class="app-header">
  <a href="/" class="app-title">DEV CARDS</a>
  <div class="app-subtitle">GitHub Â· Collectible Â· Trading Cards</div>
</div>

<div class="search-wrap">
  <input class="search-input" id="usernameInput" type="text" placeholder="github username" autocomplete="off" />
  <button class="search-btn" id="generateBtn" onclick="generateCard()">GENERATE</button>
</div>

<div class="examples">Try: <span onclick="quickGen('torvalds')">torvalds</span><span onclick="quickGen('gaearon')">gaearon</span><span onclick="quickGen('sindresorhus')">sindresorhus</span></div>

<div class="status-msg" id="statusMsg"></div>

<div id="cardContainer" class="hidden">
  <div class="card-scene">
    <div class="card" id="devCard">
      <div class="card-bg" id="cardBg"></div>
      <div class="card-foil"></div>
      <div class="card-inner">
        <div class="card-header">
          <div class="card-series">DEV CARDS // S01</div>
          <div class="rarity-block">
            <div class="rarity-badge" id="rarityBadge"></div>
            <div class="rarity-modifier hidden" id="rarityModifier"></div>
          </div>
        </div>
        <div class="card-portrait-wrap">
          <div class="card-portrait-frame">
            <img class="card-avatar" id="cardAvatar" src="" alt="avatar" crossorigin="anonymous" />
          </div>
        </div>
        <div class="card-name-block">
          <div class="card-name" id="cardName"></div>
          <div class="card-handle" id="cardHandle"></div>
        </div>
        <div class="card-ability" id="cardAbility">
          <div class="card-ability-label">SPECIAL ABILITY</div>
          <div class="card-ability-text" id="abilityText"></div>
        </div>
        <div class="card-stats">
          <div class="stat-cell">
            <div class="stat-val" id="statRepos">â€”</div>
            <div class="stat-label">Repos</div>
          </div>
          <div class="stat-cell">
            <div class="stat-val" id="statStars">â€”</div>
            <div class="stat-label">Stars</div>
          </div>
          <div class="stat-cell">
            <div class="stat-val" id="statFollowers">â€”</div>
            <div class="stat-label">Followers</div>
          </div>
        </div>
        <div class="card-footer">
          <div class="card-lang-badges" id="langBadges"></div>
          <div class="card-meta">
            <div class="card-vintage hidden" id="cardVintage"></div>
            <div class="card-number" id="cardNumber"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card-actions">
    <button class="action-btn" id="downloadBtn" onclick="downloadCard()">â¬‡ SAVE</button>
    <button class="action-btn share-btn" onclick="shareCard()">ğ• SHARE</button>
    <button class="action-btn gitdex-btn" id="gitdexBtn" onclick="addToGitDex()">+ GITDEX</button>
  </div>
</div>

<div class="gitdex-section hidden" id="gitdexSection">
  <div class="gitdex-header">
    <span class="gitdex-title">GITDEX</span>
    <span class="gitdex-count" id="gitdexCount"></span>
  </div>
  <div class="gitdex-grid" id="gitdexGrid"></div>
</div>

<script>
let currentCardData = null;
let dragSrcUsername = null;

const LANG_COLORS = {
  JavaScript: '#f1e05a', TypeScript: '#3178c6', Python: '#3572A5',
  Rust: '#dea584', Go: '#00add8', Java: '#b07219', Ruby: '#701516',
  'C++': '#f34b7d', C: '#555555', 'C#': '#178600', PHP: '#4F5D95',
  Swift: '#F05138', Kotlin: '#A97BFF', Shell: '#89e051', HTML: '#e34c26',
  CSS: '#563d7c', Vue: '#41b883', Dart: '#00B4AB', Elixir: '#6e4a7e',
  Haskell: '#5e5086', Lua: '#000080', Scala: '#c22d40', R: '#198CE7',
  Nix: '#7e7eff', Assembly: '#6E4C13', MATLAB: '#e16737',
};

function getLangColor(lang) {
  return LANG_COLORS[lang] || '#888';
}

function calcRarity(stars, followers) {
  const score = stars + followers * 2;
  if (score > 50000) return { label: 'LEGENDARY', color: '#ffd700', grad: ['#1a1200','#2a1f00'] };
  if (score > 5000)  return { label: 'EPIC',      color: '#b400ff', grad: ['#120016','#1e0028'] };
  if (score > 500)   return { label: 'RARE',      color: '#00a8ff', grad: ['#001222','#001e33'] };
  if (score > 50)    return { label: 'UNCOMMON',  color: '#00cc88', grad: ['#001a10','#002a1a'] };
  return               { label: 'COMMON',    color: '#888888', grad: ['#111111','#1a1a1a'] };
}

function fmtNum(n) {
  if (n >= 1000) return (n/1000).toFixed(1).replace(/\.0$/,'') + 'K';
  return String(n);
}

function buildAbility(data, langs) {
  const topLang = langs[0] || 'Unknown';
  const score = data.public_repos;
  const followers = data.followers;
  if (langs.length >= 6) return `Polyglot Architect â€” Fluent in ${langs.length} languages`;
  if (followers > 10000)  return `Open Source Icon â€” ${fmtNum(followers)} developers follow their work`;
  if (score > 100)        return `Repo Hoarder â€” ${score} public repos and counting`;
  if (data.hireable)      return `Available for Hire â€” ${topLang} specialist seeking quests`;
  if (data.blog)          return `Builder & Writer â€” Ships code and shares knowledge`;
  return `${topLang} Craftsman â€” Forging digital experiences`;
}

function getToken() {
  return localStorage.getItem('gh_token') || null;
}

function githubHeaders() {
  const token = getToken();
  return token ? { Authorization: `Bearer ${token}` } : {};
}

async function fetchUserData(username) {
  const enc = encodeURIComponent(username);
  const opts = { headers: githubHeaders() };
  const [userRes, reposRes] = await Promise.all([
    fetch(`https://api.github.com/users/${enc}`, opts),
    fetch(`https://api.github.com/users/${enc}/repos?per_page=100&sort=updated`, opts)
  ]);

  if (!userRes.ok) {
    const remaining = userRes.headers.get('X-RateLimit-Remaining');
    const reset     = userRes.headers.get('X-RateLimit-Reset');
    const body      = await userRes.json().catch(() => ({}));

    console.error('[GitHub API]', {
      status:    userRes.status,
      message:   body.message,
      remaining: remaining,
      resetsAt:  reset ? new Date(reset * 1000).toLocaleTimeString() : null,
    });

    if (userRes.status === 404) throw new Error('User not found');
    if (userRes.status === 403 || userRes.status === 429) {
      const resetsAt = reset ? ` Resets at ${new Date(reset * 1000).toLocaleTimeString()}.` : '';
      throw new Error(`Rate limit exceeded.${resetsAt}`);
    }
    throw new Error(body.message || `GitHub API error (${userRes.status})`);
  }

  const user = await userRes.json();
  const repos = reposRes.ok ? await reposRes.json() : [];
  return { user, repos };
}

function computeStats(repos) {
  const stars = repos.reduce((s,r) => s + r.stargazers_count, 0);
  const langMap = {};
  repos.forEach(r => { if (r.language) langMap[r.language] = (langMap[r.language]||0) + 1; });
  const langs = Object.entries(langMap).sort((a,b)=>b[1]-a[1]).map(e=>e[0]);
  return { stars, langs };
}

const VALID_USERNAME = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,37}[a-zA-Z0-9]$|^[a-zA-Z0-9]$/;

async function generateCard() {
  const username = document.getElementById('usernameInput').value.trim();
  if (!username || !VALID_USERNAME.test(username)) return;
  await renderCard(username);
}

async function renderCard(username) {
  const btn = document.getElementById('generateBtn');
  const status = document.getElementById('statusMsg');
  const container = document.getElementById('cardContainer');

  btn.disabled = true;
  container.classList.add('hidden');
  status.textContent = 'Fetching data...';
  status.className = 'status-msg';

  try {
    const { user, repos } = await fetchUserData(username);
    const { stars, langs } = computeStats(repos);
    const rarity = calcRarity(stars, user.followers);
    const ability = buildAbility(user, langs);
    const topLang = langs[0] || null;
    const accentColor = topLang ? getLangColor(topLang) : rarity.color;

    const joinYear = new Date(user.created_at).getFullYear();
    const veteranLabel = (new Date().getFullYear() - joinYear) >= 10 ? 'VETERAN' : null;

    currentCardData = {
      rarity, accentColor,
      username: user.login,
      name: user.name || user.login,
      handle: `@${user.login}`,
      avatarUrl: user.avatar_url,
      joinYear,
      veteranLabel,
    };

    // Card BG
    const cardBg = document.getElementById('cardBg');
    cardBg.style.background = `
      radial-gradient(ellipse at 50% 0%, ${accentColor}22 0%, transparent 65%),
      linear-gradient(170deg, ${rarity.grad[0]} 0%, ${rarity.grad[1]} 100%)
    `;

    // Rarity badge
    const rb = document.getElementById('rarityBadge');
    rb.textContent = rarity.label;
    rb.style.color = rarity.color;
    rb.style.borderColor = rarity.color;

    // Avatar
    const av = document.getElementById('cardAvatar');
    av.src = user.avatar_url;
    document.getElementById('cardBg').style.setProperty('--card-bg-end', rarity.grad[1]);

    // Name
    document.getElementById('cardName').textContent = user.name || user.login;
    document.getElementById('cardHandle').textContent = `@${user.login}`;

    // Ability
    document.getElementById('abilityText').textContent = ability;
    document.getElementById('cardAbility').style.borderColor = accentColor;

    // Stats
    document.getElementById('statRepos').textContent = fmtNum(user.public_repos);
    document.getElementById('statStars').textContent = fmtNum(stars);
    document.getElementById('statFollowers').textContent = fmtNum(user.followers);

    // Lang badges
    const lb = document.getElementById('langBadges');
    lb.innerHTML = '';
    langs.slice(0,4).forEach((lang) => {
      const badge = document.createElement('div');
      badge.className = 'lang-badge';
      badge.style.borderLeft = `2px solid ${getLangColor(lang)}`;
      badge.style.borderRadius = '0 2px 2px 0';
      badge.textContent = lang;
      lb.appendChild(badge);
    });

    // Card number
    document.getElementById('cardNumber').textContent = `#${String(user.id).padStart(7,'0')} Â· DEV-S01`;

    // Vintage + veteran modifier
    const vintageEl = document.getElementById('cardVintage');
    vintageEl.textContent = `EST. ${joinYear}`;
    vintageEl.classList.remove('hidden');

    const modEl = document.getElementById('rarityModifier');
    if (veteranLabel) {
      modEl.textContent = veteranLabel;
      modEl.classList.remove('hidden');
    } else {
      modEl.classList.add('hidden');
    }

    status.textContent = '';
    container.classList.remove('hidden');
    updateGitDexBtn();
    history.replaceState(null, '', `?user=${encodeURIComponent(username)}`);

    // Mouse parallax
    const card = document.getElementById('devCard');
    card.onmousemove = (e) => {
      const rect = card.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width - 0.5;
      const y = (e.clientY - rect.top) / rect.height - 0.5;
      card.style.transform = `rotateY(${x * 14}deg) rotateX(${-y * 10}deg) scale(1.02)`;
    };
    card.onmouseleave = () => {
      card.style.transform = '';
    };

    card.onclick = () => {
      window.open(`https://github.com/${encodeURIComponent(user.login)}`, '_blank', 'noopener,noreferrer');
    };

  } catch(err) {
    status.textContent = err.message;
    status.className = 'status-msg error';
  }

  btn.disabled = false;
}

function quickGen(name) {
  document.getElementById('usernameInput').value = name;
  renderCard(name);
}

document.getElementById('usernameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') generateCard();
});

// â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function downloadCard() {
  if (!currentCardData) return;
  const btn = document.getElementById('downloadBtn');
  btn.textContent = 'â³ SAVING...';
  btn.disabled = true;
  try {
    const canvas = await drawCardToCanvas();
    const link = document.createElement('a');
    link.download = `devcard-${currentCardData.username}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  } catch (err) {
    console.error(err);
    alert('Export failed. Try right-clicking the card and saving as image.');
  } finally {
    btn.textContent = 'â¬‡ SAVE';
    btn.disabled = false;
  }
}

// â”€â”€ Share to X â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function shareCard() {
  if (!currentCardData) return;
  const { name, rarity } = currentCardData;
  const text = `Just generated a ${rarity.label} Dev Card for ${name} ğŸƒ #DevCards`;
  const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`;
  window.open(url, '_blank', 'width=560,height=420');
}

// â”€â”€ GitDex â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getDex() {
  try {
    const raw = JSON.parse(localStorage.getItem('gitdex') || '[]');
    if (!Array.isArray(raw)) return [];
    return raw.filter(e =>
      e && typeof e.username === 'string' && VALID_USERNAME.test(e.username) &&
      typeof e.name === 'string' &&
      typeof e.avatarUrl === 'string' && e.avatarUrl.startsWith('https://avatars.githubusercontent.com') &&
      typeof e.rarityColor === 'string' && /^#[0-9a-fA-F]{6}$/.test(e.rarityColor) &&
      typeof e.rarityLabel === 'string' && ['COMMON','UNCOMMON','RARE','EPIC','LEGENDARY'].includes(e.rarityLabel)
    );
  } catch { return []; }
}

function saveDex(dex) {
  localStorage.setItem('gitdex', JSON.stringify(dex));
}

function updateGitDexBtn() {
  if (!currentCardData) return;
  const dex = getDex();
  const btn = document.getElementById('gitdexBtn');
  const inDex = dex.some(e => e.username === currentCardData.username);
  btn.textContent = inDex ? 'âœ“ IN DEX' : '+ GITDEX';
  btn.classList.toggle('in-dex', inDex);
}

function addToGitDex() {
  if (!currentCardData) return;
  const dex = getDex();
  const { username, name, avatarUrl, rarity } = currentCardData;
  if (dex.some(e => e.username === username)) return;
  dex.unshift({ username, name, avatarUrl, rarityLabel: rarity.label, rarityColor: rarity.color });
  saveDex(dex);
  updateGitDexBtn();
  renderGitDex();
}

function removeFromGitDex(username) {
  const dex = getDex().filter(e => e.username !== username);
  saveDex(dex);
  if (currentCardData && currentCardData.username === username) updateGitDexBtn();
  renderGitDex();
}

function renderGitDex() {
  const dex = getDex();
  const section = document.getElementById('gitdexSection');
  const grid = document.getElementById('gitdexGrid');
  const count = document.getElementById('gitdexCount');

  if (dex.length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  count.textContent = `${dex.length} CARD${dex.length !== 1 ? 'S' : ''}`;

  grid.innerHTML = '';
  dex.forEach(entry => {
    const tile = document.createElement('div');
    tile.className = 'dex-tile';
    tile.draggable = true;
    tile.dataset.username = entry.username;

    const img = document.createElement('img');
    img.className = 'dex-tile__avatar';
    img.src = entry.avatarUrl;
    img.alt = entry.username;
    img.style.borderColor = entry.rarityColor;
    img.loading = 'lazy';
    const nameEl = document.createElement('div');
    nameEl.className = 'dex-tile__name';
    nameEl.textContent = entry.username;
    const rarityEl = document.createElement('div');
    rarityEl.className = 'dex-tile__rarity';
    rarityEl.style.color = entry.rarityColor;
    rarityEl.textContent = entry.rarityLabel;
    const removeBtn = document.createElement('button');
    removeBtn.className = 'dex-tile__remove';
    removeBtn.title = 'Remove';
    removeBtn.textContent = 'Ã—';
    tile.append(img, nameEl, rarityEl, removeBtn);

    // Mouse drag events (desktop)
    tile.addEventListener('dragstart', (e) => {
      dragSrcUsername = entry.username;
      e.dataTransfer.effectAllowed = 'move';
      tile.style.opacity = '0.4';
    });
    tile.addEventListener('dragend', () => {
      tile.style.opacity = '';
      document.querySelectorAll('.dex-tile--drag-over').forEach(el => el.classList.remove('dex-tile--drag-over'));
    });
    tile.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      if (entry.username !== dragSrcUsername) tile.classList.add('dex-tile--drag-over');
    });
    tile.addEventListener('dragleave', () => {
      tile.classList.remove('dex-tile--drag-over');
    });
    tile.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      tile.classList.remove('dex-tile--drag-over');
      if (!dragSrcUsername || dragSrcUsername === entry.username) return;
      const newDex = getDex();
      const fromIdx = newDex.findIndex(x => x.username === dragSrcUsername);
      const toIdx   = newDex.findIndex(x => x.username === entry.username);
      if (fromIdx === -1 || toIdx === -1) return;
      const [moved] = newDex.splice(fromIdx, 1);
      newDex.splice(toIdx, 0, moved);
      saveDex(newDex);
      renderGitDex();
    });

    // Touch drag events (mobile)
    let touchDragging = false;
    let touchStartX = 0, touchStartY = 0;

    tile.addEventListener('touchstart', (e) => {
      touchDragging = false;
      dragSrcUsername = entry.username;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    tile.addEventListener('touchmove', (e) => {
      const dx = e.touches[0].clientX - touchStartX;
      const dy = e.touches[0].clientY - touchStartY;
      if (!touchDragging && Math.hypot(dx, dy) < 8) return; // ignore tiny movements
      if (!touchDragging) tile.classList.add('dex-tile--dragging'); // lift on threshold cross
      touchDragging = true;
      e.preventDefault(); // block scroll while dragging
      const touch = e.touches[0];
      // Temporarily hide the dragged tile so elementFromPoint finds the tile underneath
      tile.style.visibility = 'hidden';
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      tile.style.visibility = '';
      const targetTile = target && target.closest('.dex-tile');
      document.querySelectorAll('.dex-tile--drag-over').forEach(el => el.classList.remove('dex-tile--drag-over'));
      if (targetTile && targetTile !== tile) targetTile.classList.add('dex-tile--drag-over');
    }, { passive: false });

    tile.addEventListener('touchend', (e) => {
      tile.classList.remove('dex-tile--dragging');
      document.querySelectorAll('.dex-tile--drag-over').forEach(el => el.classList.remove('dex-tile--drag-over'));
      if (!touchDragging) { dragSrcUsername = null; return; } // was a tap, let click handler fire
      touchDragging = false;
      const touch = e.changedTouches[0];
      tile.style.visibility = 'hidden';
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      tile.style.visibility = '';
      const targetTile = target && target.closest('.dex-tile');
      const targetUsername = targetTile && targetTile.dataset.username;
      if (!targetUsername || targetUsername === dragSrcUsername) { dragSrcUsername = null; return; }
      const newDex = getDex();
      const fromIdx = newDex.findIndex(x => x.username === dragSrcUsername);
      const toIdx   = newDex.findIndex(x => x.username === targetUsername);
      dragSrcUsername = null;
      if (fromIdx === -1 || toIdx === -1) return;
      const [moved] = newDex.splice(fromIdx, 1);
      newDex.splice(toIdx, 0, moved);
      saveDex(newDex);
      renderGitDex();
    });

    removeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      removeFromGitDex(entry.username);
    });
    tile.addEventListener('click', () => {
      document.getElementById('usernameInput').value = entry.username;
      renderCard(entry.username);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    grid.appendChild(tile);
  });
}

// â”€â”€ Canvas export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function drawCardToCanvas() {
  const { rarity, accentColor, joinYear, veteranLabel } = currentCardData;
  const name      = document.getElementById('cardName').textContent;
  const handle    = document.getElementById('cardHandle').textContent;
  const ability   = document.getElementById('abilityText').textContent;
  const repos     = document.getElementById('statRepos').textContent;
  const stars     = document.getElementById('statStars').textContent;
  const followers = document.getElementById('statFollowers').textContent;
  const cardNum   = document.getElementById('cardNumber').textContent;
  const rarityLbl = document.getElementById('rarityBadge').textContent;
  const langBadges = [...document.querySelectorAll('#langBadges .lang-badge')].map(b => ({
    text: b.textContent.trim(), color: b.style.borderLeftColor,
  }));

  let avatarImg = null;
  try { avatarImg = await loadImgCORS(document.getElementById('cardAvatar').src); } catch(e) {}

  const scale = 3, W = 340, H = 520;
  const canvas = document.createElement('canvas');
  canvas.width  = W * scale;
  canvas.height = H * scale;
  const ctx = canvas.getContext('2d');
  ctx.scale(scale, scale);

  // Clip to card rounded rect
  rrPath(ctx, 0, 0, W, H, 12); ctx.clip();

  // Background gradient
  const bg = ctx.createLinearGradient(0, 0, 0, H);
  bg.addColorStop(0, rarity.grad[0]); bg.addColorStop(1, rarity.grad[1]);
  ctx.fillStyle = bg; ctx.fillRect(0, 0, W, H);

  // Accent radial glow
  const rgb = hexToRgb(accentColor);
  if (rgb) {
    const rg = ctx.createRadialGradient(W/2, 0, 0, W/2, 0, W * 0.65);
    rg.addColorStop(0, `rgba(${rgb},0.13)`); rg.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = rg; ctx.fillRect(0, 0, W, H);
  }

  function ls(v) { if ('letterSpacing' in ctx) ctx.letterSpacing = v; }

  // --- Header ---
  ctx.font = '11px "Bebas Neue", sans-serif'; ls('3.3px');
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.fillText('DEV CARDS // S01', 18, 26); ls('0px');

  // Rarity badge
  ctx.font = '11px "Bebas Neue", sans-serif'; ls('2.2px');
  const rtw = ctx.measureText(rarityLbl).width;
  const bPad = 10, bH = 18, bW = rtw + bPad * 2 + 4;
  const bX = W - 18 - bW, bY = 14;
  ctx.strokeStyle = rarity.color; ctx.lineWidth = 1;
  ctx.strokeRect(bX + 0.5, bY + 0.5, bW - 1, bH - 1);
  ctx.fillStyle = rarity.color;
  ctx.fillText(rarityLbl, bX + bPad, bY + 13); ls('0px');

  // Veteran modifier below badge
  if (veteranLabel) {
    ctx.font = '9px "Bebas Neue", sans-serif'; ls('2px');
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.textAlign = 'right';
    ctx.fillText(veteranLabel, W - 18, bY + bH + 11);
    ls('0px'); ctx.textAlign = 'left';
  }

  // --- Portrait ---
  // py must clear the header: with veteran modifier the rarity-block is taller
  const px = 18, py = veteranLabel ? 56 : 40, pw = W - 36, ph = 210;
  ctx.save();
  rrPath(ctx, px, py, pw, ph, 4); ctx.clip();
  if (avatarImg) {
    const iAR = avatarImg.naturalWidth / avatarImg.naturalHeight;
    const tAR = pw / ph;
    let sx = 0, sy = 0, sw = avatarImg.naturalWidth, sh = avatarImg.naturalHeight;
    if (iAR > tAR) { sw = sh * tAR; sx = (avatarImg.naturalWidth - sw) / 2; }
    else           { sh = sw / tAR; sy = (avatarImg.naturalHeight - sh) / 2; }
    if ('filter' in ctx) ctx.filter = 'contrast(1.05) saturate(1.1)';
    ctx.drawImage(avatarImg, sx, sy, sw, sh, px, py, pw, ph);
    if ('filter' in ctx) ctx.filter = 'none';
  }
  const fade = ctx.createLinearGradient(0, py + ph * 0.6, 0, py + ph);
  fade.addColorStop(0, 'rgba(0,0,0,0)'); fade.addColorStop(1, rarity.grad[1]);
  ctx.fillStyle = fade; ctx.fillRect(px, py, pw, ph);
  ctx.restore();

  // --- Name ---
  const ny = py + ph + 24;
  ctx.font = '30px "Bebas Neue", sans-serif'; ls('1.5px');
  ctx.fillStyle = '#fff';
  ctx.fillText(name.toUpperCase(), 18, ny); ls('0px');

  ctx.font = '11px "Space Mono", monospace'; ls('1.65px');
  ctx.fillStyle = 'rgba(255,255,255,0.45)';
  ctx.fillText(handle, 18, ny + 17); ls('0px');

  // --- Ability ---
  const ay = ny + 30;
  ctx.font = '600 13px "Rajdhani", sans-serif';
  ls('0.65px'); // must match render-time spacing so measureText wraps correctly
  const aLines = wrapLines(ctx, ability, W - 36 - 24);
  ls('0px');
  const abH = 8 + 14 + 4 + aLines.length * 16 + 6;

  ctx.fillStyle = 'rgba(255,255,255,0.05)'; ctx.fillRect(18, ay, W - 36, abH);
  ctx.fillStyle = accentColor;              ctx.fillRect(18, ay, 2, abH);

  ctx.font = '10px "Bebas Neue", sans-serif'; ls('2.5px');
  ctx.fillStyle = 'rgba(255,255,255,0.55)';
  ctx.fillText('SPECIAL ABILITY', 30, ay + 13); ls('0px');

  ctx.font = '600 13px "Rajdhani", sans-serif'; ls('0.65px');
  ctx.fillStyle = 'rgba(255,255,255,0.85)';
  aLines.forEach((line, i) => ctx.fillText(line, 30, ay + 13 + 4 + 13 + i * 16)); ls('0px');

  // --- Stats ---
  const sty = ay + abH + 10, sth = 62, stW = (W - 36 - 2) / 3;
  ctx.fillStyle = 'rgba(255,255,255,0.08)'; ctx.fillRect(18, sty, W - 36, sth);
  [repos, stars, followers].forEach((val, i) => {
    const cx = 18 + i * (stW + 1);
    ctx.fillStyle = 'rgba(0,0,0,0.35)'; ctx.fillRect(cx, sty, stW, sth);
    ctx.textAlign = 'center';
    const mid = cx + stW / 2;
    ctx.font = '22px "Bebas Neue", sans-serif';
    ctx.fillStyle = '#fff'; ctx.fillText(val, mid, sty + 30);
    ctx.font = '10px "Rajdhani", sans-serif'; ls('1.5px');
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.fillText(['REPOS','STARS','FOLLOWERS'][i], mid, sty + 48); ls('0px');
    ctx.textAlign = 'left';
  });

  // --- Footer ---
  ctx.font = '9px "Space Mono", monospace'; ls('0.9px');
  const cnW = ctx.measureText(cardNum).width;
  const badgeAreaW = W - 36 - cnW - 16;

  const measured = langBadges.map(b => ({ ...b, w: ctx.measureText(b.text).width + 18 }));
  const rows = []; let curRow = [], rowW = 0;
  for (const b of measured) {
    const needed = curRow.length ? rowW + 6 + b.w : b.w;
    if (needed > badgeAreaW && curRow.length) { rows.push(curRow); curRow = [b]; rowW = b.w; }
    else { curRow.push(b); rowW = needed; }
  }
  if (curRow.length) rows.push(curRow);

  const badgeH = 18, rowGap = 4;
  const totalBadgeH = rows.length * badgeH + Math.max(0, rows.length - 1) * rowGap;
  const badgesTopY = H - 14 - totalBadgeH;

  rows.forEach((row, ri) => {
    const rowY = badgesTopY + ri * (badgeH + rowGap);
    let cx2 = 18;
    row.forEach(b => {
      badgeBgPath(ctx, cx2, rowY, b.w, badgeH, 2); ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fill();
      ctx.fillStyle = b.color || '#888'; ctx.fillRect(cx2, rowY, 2, badgeH);
      ctx.fillStyle = 'rgba(255,255,255,0.65)'; ctx.fillText(b.text, cx2 + 10, rowY + 12);
      cx2 += b.w + 6;
    });
  }); ls('0px');

  ctx.font = '9px "Space Mono", monospace'; ls('0.9px');
  ctx.textAlign = 'right';
  ctx.fillStyle = 'rgba(255,255,255,0.35)';
  ctx.fillText(`EST. ${joinYear}`, W - 18, badgesTopY + totalBadgeH - 18);
  ctx.fillStyle = 'rgba(255,255,255,0.25)';
  ctx.fillText(cardNum, W - 18, badgesTopY + totalBadgeH - 6);
  ls('0px'); ctx.textAlign = 'left';

  return canvas;
}

function rrPath(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y);
  ctx.arcTo(x + w, y, x + w, y + r, r); ctx.lineTo(x + w, y + h - r);
  ctx.arcTo(x + w, y + h, x + w - r, y + h, r); ctx.lineTo(x + r, y + h);
  ctx.arcTo(x, y + h, x, y + h - r, r); ctx.lineTo(x, y + r);
  ctx.arcTo(x, y, x + r, y, r); ctx.closePath();
}

function badgeBgPath(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + w - r, y); ctx.arcTo(x + w, y, x + w, y + r, r);
  ctx.lineTo(x + w, y + h - r); ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
  ctx.lineTo(x, y + h);
  ctx.closePath();
}

function wrapLines(ctx, text, maxW) {
  const words = text.split(' ');
  const lines = []; let cur = '';
  for (const w of words) {
    const test = cur ? cur + ' ' + w : w;
    if (ctx.measureText(test).width > maxW && cur) { lines.push(cur); cur = w; }
    else cur = test;
  }
  if (cur) lines.push(cur);
  return lines;
}

function hexToRgb(hex) {
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return m ? `${parseInt(m[1],16)},${parseInt(m[2],16)},${parseInt(m[3],16)}` : null;
}

async function loadImgCORS(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload  = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

// â”€â”€ Settings / Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleSettings() {
  const panel  = document.getElementById('settingsPanel');
  const toggle = document.getElementById('settingsToggle');
  const isOpen = panel.classList.toggle('open');
  toggle.classList.toggle('open', isOpen);
  if (isOpen) {
    const saved = getToken();
    document.getElementById('tokenInput').value = saved || '';
    document.getElementById('settingsStatus').textContent = saved ? 'Token active' : '';
    document.getElementById('settingsStatus').className = saved ? 'settings-status ok' : 'settings-status';
  }
}

function saveToken() {
  const val    = document.getElementById('tokenInput').value.trim();
  const status = document.getElementById('settingsStatus');
  const toggle = document.getElementById('settingsToggle');
  if (val) {
    localStorage.setItem('gh_token', val);
    status.textContent = 'Token saved';
    status.className = 'settings-status ok';
    toggle.classList.add('active');
  } else {
    localStorage.removeItem('gh_token');
    status.textContent = 'Token cleared';
    status.className = 'settings-status err';
    toggle.classList.remove('active');
  }
}

// Init
renderGitDex();
if (getToken()) document.getElementById('settingsToggle').classList.add('active');
const _initUser = new URLSearchParams(window.location.search).get('user');
if (_initUser && VALID_USERNAME.test(_initUser)) {
  document.getElementById('usernameInput').value = _initUser;
  renderCard(_initUser);
}
</script>
</body>
</html>
